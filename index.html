<!DOCTYPE html>
<html>
<head>
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <link href='http://fonts.googleapis.com/css?family=Amatic+SC:400,700' rel='stylesheet' type='text/css'>
<style>
  body {
    font-family: 'Amatic SC', cursive, sans-serif;
    font-size: 25px;
  }
  canvas#canvas {
    float: left;
    cursor: crosshair;
    border: 1px solid gray;
  }
  a {
    margin-left: 5px;
    padding: 10px;
    cursor: pointer;
    color: white;
    text-decoration: none;
    border-radius: 6px;
  }
  #save {
    background: #0D9CC7;
  }
  #clear {
    background: #FF3333;
  }
  .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
</style>
</head>

<body>
<canvas id="canvas" class="noselect"></canvas>
<div id="buttons">
  <!-- buttons -->
  <br>
  <a id="save" class="noselect">Save</a>
  <br>
  <br>
  <a id="clear" class="noselect">Clear</a>
  <br>
  <br>
  <br>
  <!-- checkboxes -->
  <input type="checkbox" id="cursor" class="noselect" checked/> Show Cursor
</div>
<!-- Wacom plugin -->
<object id="wtPlugin" type="application/x-wacomtabletplugin">
  <param name="onload" value="pluginLoaded"/>
</object>
</body>

<script type='text/javascript' src="ploma.o.s.js"></script>

<script type="text/javascript">
  "use strict";

  // DOM
  var body;
  var canvas;
  var save;
  var clear;
  var cursor;
  var plugin;
  var penAPI;
  var extendStroke;

  // State
  var mode = 0;
  var ploma = null;
  var w = 1300;
  var h = 1000;
  var parallaxOffsetX = 10;
  var parallaxOffsetY = 10;
  var bodyScrollTop = 0;
  var mouseOffsetX = -1 * parallaxOffsetX;
  var mouseOffsetY = -1 * parallaxOffsetY;
  var isDrawing = false;

  // Red Pixel
  var r = new Uint8ClampedArray(16);
  var rid;
  r[0] = 255;
  r[3] = 255;
  r[4] = 255;
  r[7] = 255;
  r[8] = 255;
  r[11] = 255;
  r[12] = 255;
  r[15] = 255;

  /////////////
  // CALLBACKS
  /////////////
  function pluginLoaded() {
    // TODO: DOES NOT WORK ON FIREFOX
    console.log('pluginLoaded: ' + plugin);
    penAPI = plugin.penAPI;
  }

  function toggleCursor() {
    // TODO: UPDATE CHECKBOX OR IMAGE ON BUTTON
    if(canvas.style.cursor === 'none') {
      canvas.style.cursor = 'crosshair';
    } else {
      canvas.style.cursor = 'none';
    }
  }

  /////////////
  // ONLOAD
  /////////////
  window.onload = function() {

    // load DOM elements
    body = document.getElementsByTagName('body')[0];
    canvas = document.getElementById('canvas');
    canvas.setAttribute('width', w);
    canvas.setAttribute('height', h);
    save = document.getElementById('save');
    clear = document.getElementById('clear');
    cursor = document.getElementById('cursor');
    plugin = document.getElementById('wtPlugin');

    // populate red pixel
    rid = canvas.getContext('2d').createImageData(2, 2);
    rid.data.set(r);

    // load Ploma onto canvas and clear it
    ploma = new Ploma(canvas);
    ploma.clear();
    extendStroke = ploma.extendStroke;

    // bind button events
    save.onclick = function(e) {
      window.open(canvas.toDataURL());
    }
    clear.onclick = function(e) {
      ploma.clear();
    }
    cursor.onclick = function(e) {
      toggleCursor();
    }

    // bind keyboard events
    window.onkeydown = function(e) {
      switch(e.keyCode) {
        // '0'
        case 48:
          mode = 0;
          ploma.clear();
          break;
        // '1'
        case 49:
          mode = 1;
          ploma.clear();
          ploma.setSample(1);
          break;
        // '2'
        case 50:
          mode = 2;
          ploma.clear();
          ploma.setSample(2);
          break;
        // 'r'
        case 82:
          toggleCursor();
          break;
        // 'c'
        case 67:
          ploma.clear();
      }
    }

    // bind scroll
    window.onscroll = function (event) {
      mouseOffsetX = body.scrollLeft - parallaxOffsetX;
      mouseOffsetY = body.scrollTop - parallaxOffsetY;
    }

    // bind device input events
    /*if(window.PointerEvent) {
      ///////////////////////////////////
      // POINTER EVENT
      ///////////////////////////////////
      canvas.onpointerdown = function(e) {
        ploma.beginStroke(
          e.clientX + mouseOffsetX,
          e.clientY + mouseOffsetY,
          e.pressure
        );
        isDrawing = true;
      }
      canvas.onpointermove = function(e) {
        if (!isDrawing) return;
        ploma.extendStroke(
          e.clientX + mouseOffsetX,
          e.clientY + mouseOffsetY,
          e.pressure
        );
      }
      canvas.onpointerup = function(e) {
        ploma.endStroke(
          e.clientX + mouseOffsetX,
          e.clientY + mouseOffsetY,
          e.pressure
        );
        isDrawing = false;
      }
    } else {*/
      ///////////////////////////////////
      // MOUSE EVENT
      ///////////////////////////////////
      canvas.onmousedown = function(e) {
        isDrawing = true;
        if (mode === 0) return;
        ploma.beginStroke(
          e.clientX + mouseOffsetX,
          e.clientY + mouseOffsetY,
          penAPI ? penAPI.pressure : 1
        );
      }
      canvas.onmousemove = function(e) {
        if (!isDrawing) return;
        if (mode === 0) {
          canvas.getContext('2d').putImageData(rid, e.clientX + mouseOffsetX, e.clientY + mouseOffsetY, 0, 0, 2, 2);
          return;
        }
        ploma.extendStroke(
          e.clientX + mouseOffsetX,
          e.clientY + mouseOffsetY,
          penAPI ? penAPI.pressure : 1
        );
      }
      canvas.onmouseup = function(e) {
        isDrawing = false;
        if (mode === 0) return;
        ploma.endStroke(
          e.clientX + mouseOffsetX,
          e.clientY + mouseOffsetY,
          penAPI ? penAPI.pressure : 1
        );
      }
    //} 
  }

</script>

</html>
