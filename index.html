<html>
<head>
<style>
  body {
    font-family: sans-serif;
  }
  canvas#canvas {
    float: left;
    cursor: none;
    border: 1px solid gray;
  }
  canvas#texture-canvas {
    display: none;
  }
  img {
    display: none;
  }
  a {
    padding: 10px;
    line-height: 40px;
    cursor: pointer;
    color: white;
    text-decoration: none;
  }
  .noselect {
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }
  #save {
    background: #3B2D38;
  }
  #clear {
    background: #F02475;
  }
</style>
</head>

<body>
<canvas id="canvas"></canvas>
<canvas id="texture-canvas"></canvas>
<div id="buttons">
  <!-- buttons -->
  <a id="save" class="noselect">Save</a>
  <br>
  <br>
  <a id="clear" class="noselect">Clear</a>
  <br>
  <br>
  <br>
  <!-- checkboxes -->
  <input type="checkbox" id="cursor" class="noselect"/> Show Cursor
  <br>
  <input type="checkbox" id="mouse" class="noselect"/> Use Mouse
</div>
<!-- texture -->
<img src="img/rubbing_to_mask 9a.jpeg" id="texture"/>
<!-- Wacom plugin -->
<object id="wtPlugin" type="application/x-wacomtabletplugin">
  <param name="onload" value="pluginLoaded"/>
</object>
</body>

<script type='text/javascript' src="js/ploma.js"></script>

<script type="text/javascript">
  var useMouse = false;
  var w = 1300;
  var h = 1000;
  var cursorOffsetX = 8;
  var cursorOffsetY = 8;
  var textureCanvas;
  var save;
  var clear;
  var plugin;
  var cursor;
  var sketcherA;

  window.onload = function() {

    // load DOM elements
    canvas = document.getElementById('canvas');
    canvas.setAttribute('width', w);
    canvas.setAttribute('height', h);
    save = document.getElementById('save');
    clear = document.getElementById('clear');
    cursor = document.getElementById('cursor');
    texture = document.getElementById("texture");
    textureCanvas = document.getElementById("texture-canvas");
    plugin = document.getElementById('wtPlugin');

    // prepare textures
    textureCanvas.width = texture.width;
    textureCanvas.height = texture.height;
    textureCanvas.getContext('2d').drawImage(texture, 0, 0, texture.width, texture.height);

    // If pen is not detected at startup
    // assume that we're using a mouse
    // TODO: check and test thoroughly
    //if (!plugin.penAPI || !plugin.penAPI.pressure) {
    //  useMouse = true;
    //  mouse.checked = true;
    //}

    // initialize events
    save.onclick = function(e) {
      window.open(canvas.toDataURL());
    }
    clear.onclick = function(e) {
      sketcherA.clear();
    }
    cursor.onclick = function(e) {
      if(cursor.checked) {
        canvas.style.cursor = 'crosshair';
      } else {
        canvas.style.cursor = 'none';
      }
    }
    mouse.onclick = function(e) {
      useMouse = mouse.checked;
    }
    canvas.onmousedown = function(e) {
      var point = getEventPoint(e)
      sketcherA.beginStroke(point.x, point.y, point.p);
    }
    canvas.onmousemove = function(e) {
      var point = getEventPoint(e)
      sketcherA.extendStroke(point.x, point.y, point.p);
    }
    canvas.onmouseup = function(e) {
      var point = getEventPoint(e);
      sketcherA.endStroke(point.x, point.y, point.p);
    }

    // load Ploma onto canvas and clear it
    sketcherA = new Ploma.Sketcher(canvas, textureCanvas);
    sketcherA.clear();
  }

  function getEventPoint(e) {
    return {
      x: e.clientX - cursorOffsetX + document.getElementsByTagName('body')[0].scrollLeft,
      y: e.clientY - cursorOffsetY + document.getElementsByTagName('body')[0].scrollTop,
      p: (useMouse ? 1: plugin.penAPI.pressure)
    }
  }

</script>

</html>
