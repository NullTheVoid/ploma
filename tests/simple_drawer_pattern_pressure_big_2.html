<html>
  <head>
    <style>
      canvas {
        cursor: url('cursors/cursor.cur'), crosshair;
      }
      img {
        display: none;
      }
    </style>
  </head>

  <body>
    <canvas id="c" width="1300" height="950"></canvas>
    <img src="img/transparency140b.png" id="img"/>
    <object id="wtPlugin" type="application/x-wacomtabletplugin">
      <param name="onload" value="pluginLoaded" />
    </object>
  </body>

  <script>
    var el = document.getElementById('c');
    var img = document.getElementById("img");
    var plugin = document.getElementById('wtPlugin');
    var ctx = el.getContext('2d');
    var pat = ctx.createPattern(img,"repeat");
    var cursorOffsetX = 12;
    var cursorOffsetY = 8;
    var isDrawing = false;
    var isSkipping = false;
    var skipCounter = 0;
    var penDownFrame = 0;
    var emptyInk = true;
    var points = [];
    var x;
    var y;
    var px;
    var py;

    ctx.lineCap = 'square';
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    ctx.fillStyle = 'rgb(252, 252, 238)';
    ctx.fillRect(0, 0, 1300, 950);

    el.onmousedown = function(e) {
      isDrawing = true;
      x = e.clientX - cursorOffsetX;
      y = e.clientY - cursorOffsetY;
      px = x;
      py = y;
      penDownFrame = 0;
    };

    el.onmousemove = function(e) {
      var minx;
      var miny;
      var pressure;
      var point;

      penDownFrame++;

      if (!isDrawing) {
        return;
      }

      x = e.clientX - cursorOffsetX;
      y = e.clientY - cursorOffsetY;
      minx = Math.min(x, px) + Math.random()*50;
      miny = Math.min(y, py) + Math.random()*50;

      point = {
        isWacom      : plugin.penAPI.isWacom,
        isEraser     : plugin.penAPI.isEraser,
        posX         : plugin.penAPI.posX,
        posY         : plugin.penAPI.posY,
        sysX         : plugin.penAPI.sysX,
        sysY         : plugin.penAPI.sysY,
        tabX         : plugin.penAPI.tabX,
        tabY         : plugin.penAPI.tabY,
        rotationDeg  : plugin.penAPI.rotationDeg,
        rotationRad  : plugin.penAPI.rotationRad,
        tiltX        : plugin.penAPI.tiltX,
        tiltY        : plugin.penAPI.tiltY,
        tangPressure : plugin.penAPI.tangentialPressure,
        version      : plugin.penAPI.version,
        pointerType  : plugin.penAPI.pointerType,
        tabletModel  : plugin.penAPI.tabletModel,
        pressure     : plugin.penAPI.pressure,
        canvasX      : x,
        canvasY      : y,
        time         : Date.now()
      };
      points.push(point);

      // set stroke and size according to pressure
      ctx.lineWidth = calcLineWidth(point.pressure);
      ctx.strokeStyle = calcStrokeStyle(point.pressure);
      ctx.globalAlpha = calcGlobalAlpha(point.pressure);

      // stroke line in offset canvas
      ctx.translate(minx, miny);
      ctx.beginPath();
      ctx.moveTo(px - minx, py - miny);
      ctx.lineTo(x - minx, y - miny);
      ctx.stroke();
      ctx.closePath();
      ctx.translate(-minx, -miny);

      px = x;
      py = y;
    };

    el.onmouseup = function() {
      isDrawing = false;
      points.push({break: true});
    };

    function calcLineWidth(p) {
      return (p < 0.6) ? 1 : 2;
    }

    function calcStrokeStyle(p) {
      return pat;
    }

    function calcGlobalAlpha(p) {
      var alpha;

      if(isSkipping && (skipCounter > 50)) {
        isSkipping = false;
        skipCounter = 0;
      }

      if(emptyInk && (penDownFrame < 5)) {
        isSkipping = true;
        emptyInk = false;
        window.setTimeout(function() {
          emptyInk = true;
        }, 5000);
      }

      if(isSkipping) {
        alpha = 0.5;
        skipCounter++;
      } else {
        alpha = (p < 0.5) ? 0.9 : 1;
      }
      
      return alpha;
    }

    //**********************************************************************
    // window.onkeypress
    //   'i' to save out image
    //   'c' to clear canvas
    //   'j' saves points to json blob
    //
    window.onkeypress = function(e) {
      /*if (e.charCode === 99) {
        clearCanvas();
        curves.length = 0;
      }*/
      if (e.charCode === 105) {
        window.open(el.toDataURL());
      }
      if (e.charCode === 106) {
        var json = JSON.stringify(points);
        var blob = new Blob([json], {type: 'application/json'});
        var url  = URL.createObjectURL(blob);
        window.open(url);
      }
    }

  </script>

</html>